# 1.- CONSTRUIR LA IMAGEN DOCKER EN UN CONTENEDOR LIMPIO PARA ASEGURAR QUE EL AMBIENTE SE PUEDE RECREAR SIN PROBLEMAS
FROM node:12-alpine as build-stage
LABEL version="1.0"
LABEL maintainer="cristian.freire@seps.gob.ec"

# VARIABLES GLOBALES SOLICITADAS PARA COMPILAR EL PROYECTO
# TOKEN DE ACCESO AL REPOSITORIO NPM DE SEPS
ARG NPM_TOKEN
# URL DEL REPOSITORIO NPM DE SEPS
ARG NPM_REGISTRY_URL
# DOMINIO EN DONDE SE PUBLICARAN TODOS LOS MICROFRONTENDS
ARG MF_DOMAIN

ARG MF_DOMAIN=http://localhost
# PARAMETRO PARA EL MANEJO DE VERSIONES DE LOS MICROFRONTENDS

ARG APP_VERSION=v1
# PARAMETRO PARA INDICAR EL AMBIENTE DE LA APLICACION
ARG NODE_ENV=production

ARG MS_PORT=80

ARG MS_HOST=localhost

#VARIABLE DE ENTORNO QUE NECESITA WEBPACK PARA COMPILAR TODOS LOS PAQUETES EN MODO PRODUCCION
ENV PRODUCTION_DOMAIN=${MF_DOMAIN}
# PARAMETRO PARA EL MANEJO DE VERSIONES DE LOS MICROFRONTENDS
ENV APP_VERSION=${APP_VERSION}
#VARIABLE DE ENTORNO PARA EL CONSUMO DE MICROFRONTENDS Y MICROSERVICIOS
ENV MF_DOMAIN=${MF_DOMAIN}
#ENTORNO DE PRODUCCION PARA LA APLICACION
ENV NODE_ENV=${NODE_ENV}

#DIRECTORIO DONDE VAMOS A COMPILAR TODO EL PROYECTO
WORKDIR /app
#COPIAR TODOS LOS MICROFRONTENDS A LA CARPETA /app DEL CONTENEDOR
COPY . .

# CREAR LA CARPETA .NPM PARA CONECTARSE AL REPOSITORIO NPM NEXUS DE SEPS
RUN echo "always-auth=true" > .npmrc && \
    echo "_auth=${NPM_TOKEN}" >> .npmrc && \
    echo "registry=${NPM_REGISTRY_URL}" >> .npmrc

# CONSTRUIR LA APLICACION
WORKDIR /app
RUN yarn install --production=false && yarn build

#2.- CONSTRUIR LA IMAGEN DOCKER COPIANDO LOS DIRECTORIOS DIST DE CADA MICROFRONTEND USANDO NGINX
FROM nginx:1.21.0

ARG APP_VERSION=v1

ARG MS_PORT

ARG MS_HOST

ENV MS_HOST=${MS_HOST}

ENV MS_PORT=${MS_PORT}

ENV APP_VERSION=${APP_VERSION}

# CREAR CARPETAS DE CADA MICROFRONTEND EN LA CARPETA HTML DE NGINX
RUN mkdir -p /usr/share/nginx/html/fr-seps-base-web/
# COPIAR LA CARPETA DIST COMPILADA DEL MICROFRONTEND DE SOLICITUD DIRECTIVAS GENERADA POR EL CONTENEDOR ANTERIOR
COPY --from=build-stage /app/dist /usr/share/nginx/html/fr-seps-base-web/

#COPIAR ARCHIVO DE CONFIGURACION DE NGINX PARA PROXIFICAR LAS PETICIONES HACIA LOS MICROSERVICIOS ASEGURADOS
COPY ./nginx.conf /etc/nginx/nginx.conf


